# 各種設定の覚書

## 主な機能
* メインカラー、サブカラー、アクセントカラーを指定すると、いい感じ（自己満足）にスタイル全体に適応させます。
  * メインカラー、サブカラー、アクセントカラー指定の際はカラーピッカー内の「SAVE」を押してください。
  * 「色を地図に反映」で色の設定を地図のスタイルへ反映します。再現性があります。
  * 「ランダムに変更」で、表示されているスタイルの色をランダム（とはいえ、ある程度規則的に）に変更します。乱数を利用するので、再現性はありません。
  * 「モノクロに変更」で、表示されているスタイルをモノクロにします。
  * 「Background」でバックグラウンド（背景色）のオン・オフができます。（オフの間も色の変更は行われます。）
  * 「ダウンロード」で、変更したスタイル用のstyle.jsonファイル（Mapbox Style Specに準拠）をダウンロードできます。
* 色の変換は、HSLベースで行っています。
  * 今のところ、指定したメインカラー・アクセントカラーの色相（H）のみ参照しています。彩度（S）、輝度（L）は操作できませんので、白黒表現にはできません。
  * モノクロ化は、Sを0にしています。
* ベースとなるスタイルは地理院地図Vectorの淡色地図（手を入れています）。
  * レイヤの"type"が"backgound"のレイヤについては、「レイヤの"id"が"background"」または「存在しない」ことを前提としています。
* 色の指定（カラーピッカー）には、「Pickr」というライブラリを利用しています。

## ランダム
* 基本は、色相Hを60度回転（そのくらいが変化がわかりやすい）。その他、色相、彩度、明度を乱数を使って変更。
* この変更は、スタイルレイヤごとに行われるため、もともと同じ色の地物でも、だんだんと色がずれていく。
* 白(L=100)については変更しない。
* text-haloも変更させない。（白に含まれているはずだが、念のため）

## モノクロ化
* もともとの彩度が0の場合は0、それ以外は1とした。
	* 最初は彩度0にしていたが、以下の彩度操作の可逆性（もともとのモノクロ部分の分別）のため、このような処理にした。

## トーンカーブ
* 「鮮やかに」、「落ち着かせて」は、彩度S、「明るく」、「暗く」は明度Lについて、円の方程式を用いてたトーンカーブを設定。
	* (変化前,変化後) = (0,0), (100,100)を通る円の円弧をトーンカーブとした。2つの円ができるが、それぞれが逆関数となる（ような気がしてるけど……）。
```
  var r = 600; //100以上で。円の半径。ここで、トーンカーブの形状を調整。
  var a = Math.sqrt((r*r + 2*50*50 - 100*100)/2) + 50;
  var b = -a + 100;
  var x = o3 + 1; //円をそのまま使うと0と100が不動なので、ここでちょっと動かしてあげる。
  var c3 = (b + Math.sqrt( r*r - (x-a)*(x-a) ) )*1 ;
```
```
  var r = 600; //100以上で。円の半径。ここで、トーンカーブの形状を調整。
  var a = -Math.sqrt((r*r + 2*50*50 - 100*100)/2) + 50;
  var b = -a + 100;
  var x = o3 - 1; //円をそのまま使うと0と100が不動なので、ここでちょっと動かしてあげる。
  var c3 = (b - Math.sqrt( r*r - (x-a)*(x-a) ) )*1 ;
```
* 円の半径で、トーンカーブの
* ただし、text-lhaloについては、文字の視認性への影響を考え、元の白のまま、彩度・明度ともに変更しないようにした。


### 「鮮やかに」、「落ち着かせて」の可逆変化の試み
* 彩度を落としていく（落ち着く）は、最終的にモノクロ化と同じになるはず。
* モノクロかどうかを見分けるのは彩度。しかし、「落ち着かせて」を最高までやると、全ての色が彩度0になってしまうので、「落ち着かせて」の処理内部で、1以下になったものは1として出力するようにした。
* 関連して、「鮮やかに」は、彩度0に対する彩度操作を行わないようにした。
* これにより、「鮮やかに」は着色部分のみ彩度を上げることができ、「落ち着かせて」でほとんどモノクロになっても、元の着色部分のみを再度鮮やかにすることができる。
* 「モノクロ化」は、彩度が0の場合は0、それ以外は1とすることで、「鮮やかに」による着色部分のみの彩度操作が可能。
* 「モノクロの着色」は不可逆的で、もともとのモノクロ部分を着色するので、「モノクロの着色」実行以降は、元のモノクロ部分は見分けられない。
```
  var r = 600; 
  var a = Math.sqrt((r*r + 2*50*50 - 100*100)/2) + 50;
  var b = -a + 100;
  var x = o3 + 1;
  var c3 = (b + Math.sqrt( r*r - (x-a)*(x-a) ) )*1 ;
  c3 = Math.round(c3);
  if(c3 > 99){
    c3 = 99; //完全に白にはしない
  }
  //白は変更しない。（「ランダム」ボタンにより、白の部分が変化するのを防ぐため、L=100はもともとの白のみとする。）
  if((o3 > 99)){
    c3 = o3;
  }
  //haloだけは変更しない
  if(prop_name.match(/text-halo-/)){
    c3 = o3;
  }
```

## 「明るく」、「暗く」の可逆変化の試み
* 「明るく」、「暗く」については、操作した値は最小値1、最大値99とし、0と100はもともとその数値を持っていた色しか取れないようにした。
* 同時に、「明るく」、「暗く」では、明度0と100に対する明度操作をしない。
* 基本的に、「白」を保存するための処置。


## モノクロの着色
* Sを上げればよい。
* ただし、白(L=100%)およびtext-haloを変更すると汚くなるので、それらは変更しないようにした。
* 真っ黒の場合、明度が0なので、着色されたように見えない。そのため、明度を少し上げるようにした。

`c3 = (o3 + 20) * (100/120);`

## ダークモード
* 黒色ベースにアクセントカラー、メインカラーがいい感じに残るように調整。
	* Sの値を完全に0にせずに、微妙に色合いを残した。
	* Style.json中のsource-layerや色だけでは地物を判別できず、metadataを参照して色分けを追加。
	* ダークモード変換後は、微調整はあまりできない。

